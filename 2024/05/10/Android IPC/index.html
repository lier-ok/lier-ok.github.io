

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/cute_icon.png">
  <link rel="icon" href="/img/cute_icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="lier">
  <meta name="keywords" content="">
  
  <title>Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>lier的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/background.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2024-05-10 14:02" pubdate>
        2024年5月10日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      107
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            <div class="markdown-body">
              <h3 id="Android-IPC"><a href="#Android-IPC" class="headerlink" title="Android IPC"></a>Android IPC</h3><h4 id="1-简介"><a href="#1-简介" class="headerlink" title="1: 简介"></a>1: 简介</h4><p>​		IPC(Inter-Process Communication), 即进程间通信或者跨进程通信, 是指两个进程间进行数据交换得过程</p>
<h4 id="2-多进程模式"><a href="#2-多进程模式" class="headerlink" title="2: 多进程模式"></a>2: 多进程模式</h4><p>​		将四大组件(Activity, Service, Receiver, ContentProvider)声明时,在AndroidMenifest中指定android:process属性</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> </span><br><span class="hljs-tag">	<span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.lier.process.MainActivity&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:configChanges</span>=<span class="hljs-string">&quot;orientationlscreenSize&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:label-</span>&quot;@<span class="hljs-attr">string</span>/<span class="hljs-attr">app_name</span>&quot;</span><br><span class="hljs-tag">    <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">&quot;standard&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name-</span>&quot;<span class="hljs-attr">android.intent.category.LAUNCHER</span>&quot; /&gt;</span>			<span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> </span><br><span class="hljs-tag">     <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.lier.process.SecondActivity&quot;</span></span><br><span class="hljs-tag">     <span class="hljs-attr">android:configChanges</span>=<span class="hljs-string">&quot;screenLayout&quot;</span></span><br><span class="hljs-tag">     <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span></span><br><span class="hljs-tag">     <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;:remote&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span></span><br><span class="hljs-tag">	<span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.lier.process.ThirdActivity&quot;</span>				 		         <span class="hljs-attr">android:configChanges</span>=<span class="hljs-string">&quot;screenLayout&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;com.lier.process.remote&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<p>​	tips: 假设当前应用得包名为: com.lier.process, 则MainActivity会运行在<strong>默认进程</strong>中, 进程名一般为包名, 而SecondActivity和ThirdActivity则会运行在各自的进程中(通过android:process指定),其进程名分别为com.lier.process: remote和com.lier.process.remote</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">可通过如下命令查看进程</span><br>adb shell ps | grep &quot;进程名&quot;<br></code></pre></td></tr></table></figure>

<p>上述使用android:process&#x3D;”进程名”中, <strong>使用符号 :  表示要在当前进程名前加当前包名, 且表示当前进程为私有进程</strong>, 其他应用组件不可抛在其中, 而其他方式不以:开头的进程属于全局进程, 其他应用可以通过ShareUID的方式和它跑在同一个进程</p>
<p>​		<strong>Android 系统会为每个应用分配一个唯一的 UID</strong>，具有相同 UID 的应用才能共享数据。这里要说明的是，两个应用通过 ShareUID 跑在同一个进程中是有要求的，<strong>需要这两个应用有相同的 ShareUID 并且签名相同才可以</strong>。在这种情况下，它们<strong>可以互相访问对方的私有数据</strong>，比如 data 目录、组件信息等，不管它们是否跑在同一个进程中。当然如果它们跑在同一个进程中，那么除了能共享 data目录、组件信息，还可以共享内存数据，或者说它们看起来就像是一个应用的两个部分。</p>
<h5 id="2-1-问题"><a href="#2-1-问题" class="headerlink" title="2.1: 问题"></a>2.1: 问题</h5><p>​			同上述Activity配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建实体类</span><br><span class="hljs-keyword">public</span> ProcessDataBean&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-comment">//在MainActivity启动时将data值赋值为2</span><br><span class="hljs-keyword">public</span> MainActivity <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span>&#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        ProcessDataBean.data = <span class="hljs-number">2</span>;<br>        Log.i(<span class="hljs-string">&quot;porcess&quot;</span>, <span class="hljs-string">&quot;data = &quot;</span> + ProcessDataBean.data);<br>        startActivity(<span class="hljs-string">&quot;com.lier.process.SecondActivity&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> SecondActivity <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        Log.i(<span class="hljs-string">&quot;porcess&quot;</span>, <span class="hljs-string">&quot;data = &quot;</span> + ProcessDataBean.data);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​    上述代码中, 启动MainActivity时, 将data值赋值为2后启动SecondActivity, 先后都打印了data值, 按照static属性的变量值应该时共享的, 但是前后打印的值分别为2和1</p>
<p>​	<strong>原因:</strong>  Android会为每一个应用或者进程分配一个虚拟机,  不同的虚拟机在内存分配上有不同地址空间, 导致不同进程访问同一个类的对象会产生多个副本, 因为上述两个Activity分别运行在不同的进程中, 所以会导致静态变量值出现不同步的问题</p>
<p>​	<strong>所以四大组件运行在不同进程中时, 只要通过内存共享数据, 都会出现该问题</strong></p>
<p>​	一般来说,多进程会造成以下问题: </p>
<p>​	<strong>(1) 静态成员完全失效</strong></p>
<p>​			上述已经解释该问题原因</p>
<p>​	<strong>(2) 线程的同步机制失效</strong></p>
<p>​			不同进程不同副本, 对象锁不一样</p>
<p>​	<strong>(3) SharedPreferences可靠性问题</strong></p>
<p>​			SharedPreferences不支持两个进程同时写, 否则可能造成数据丢失</p>
<p>​	<strong>(4) Application多次创建</strong></p>
<p>​			运行在同一个进程中的组件属于同一个虚拟机和Application, 不同的进程中组件就属于不同		的虚拟机和Application, 同一个应用中多个Activity运行在不同的进程中, 可能就会导致启动多		个Application</p>
<h5 id="2-2-如何解决"><a href="#2-2-如何解决" class="headerlink" title="2.2: 如何解决"></a>2.2: 如何解决</h5><p>​	通过安卓提供的跨进程交互的方式, 进行通信, 数据交互, 如Intent传递数据, SharedPreferences共享文件, Binder, Messenger和AIDL以及Socket等</p>
<h4 id="3-IPC基础概念"><a href="#3-IPC基础概念" class="headerlink" title="3: IPC基础概念"></a>3: IPC基础概念</h4><h5 id="3-1-序列化"><a href="#3-1-序列化" class="headerlink" title="3.1: 序列化"></a>3.1: 序列化</h5><p>​		在java中序列化使用Serializable接口, 并定义标识</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8965128956289562856L</span><br></code></pre></td></tr></table></figure>

<p>​		即可实现类的序列化</p>
<p>​		在android中提供新的序列化方式, 即使用Parcelable接口</p>
<p>​		<strong>Parcelable序列化方式比Serializable方式效率高,适用于安卓平台, 主要是在内存序列化上, 但是持久化或者网络传输序列化建议使用serializable</strong></p>
<h5 id="3-2-跨进程通信"><a href="#3-2-跨进程通信" class="headerlink" title="3.2: 跨进程通信"></a>3.2: 跨进程通信</h5><h6 id="3-2-1-aidl基本使用"><a href="#3-2-1-aidl基本使用" class="headerlink" title="3.2.1: aidl基本使用"></a>3.2.1: aidl基本使用</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Book.java</span><br><span class="hljs-keyword">package</span> com.lier.aidl.bean;<br><br><span class="hljs-keyword">import</span> android.os.Parcel;<br><span class="hljs-keyword">import</span> android.os.Parcelable;<br><span class="hljs-keyword">import</span> androidx.annotation.NonNull;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: lier</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span>: 2024/5/11</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> bookId;<br>    <span class="hljs-keyword">public</span> String bookName;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Book</span><span class="hljs-params">(<span class="hljs-type">int</span> bookId, String bookName)</span>&#123;<br>        <span class="hljs-built_in">this</span>.bookId = bookId;<br>        <span class="hljs-built_in">this</span>.bookName = bookName;<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">Book</span><span class="hljs-params">(Parcel in)</span> &#123;<br>        bookId = in.readInt();<br>        bookName = in.readString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Creator&lt;Book&gt; CREATOR = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Creator</span>&lt;Book&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Book <span class="hljs-title function_">createFromParcel</span><span class="hljs-params">(Parcel in)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(in);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Book[] newArray(<span class="hljs-type">int</span> size) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>[size];<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">describeContents</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToParcel</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Parcel dest, <span class="hljs-type">int</span> flags)</span> &#123;<br>        dest.writeInt(bookId);<br>        dest.writeString(bookName);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//Book.aidl</span><br><span class="hljs-keyword">package</span> com.lier.aidl.bean;<br><br>parcelable Book;<br><br><span class="hljs-comment">//IBookManager.aidl</span><br><span class="hljs-keyword">package</span> com.lier.aidl;<br><span class="hljs-keyword">import</span> com.lier.aidl.bean.Book;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IBookManager</span> &#123;<br>    List&lt;Book&gt; <span class="hljs-title function_">getBookList</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(in Book book)</span>;<br>&#125;<br><br><span class="hljs-comment">//IBookManager.java 由系统生成, 在build目录中</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This file is auto-generated.  DO NOT MODIFY.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">package</span> com.lier.aidl;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IBookManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">android</span>.os.IInterface<br>&#123;<br>    ......(省略)<br>&#125;<br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment">* 在该java文件中, 声明了getBookList和addBook两个方法, 并用两个id标识了该方法, id名为	* TRANSACTION_getBookList, 即TRANSACTION_函数名 --&gt; 方式</span><br><span class="hljs-comment">* 当客户端金额服务端在同一个进程是不会走onTransact, 不同进程就会走, 根据id,调用对应方法</span><br><span class="hljs-comment">* 而该方法由其静态内部类Proxy实现</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<p>​		<strong>一些说明:</strong> </p>
<p>​		1: DESCRIPTOR</p>
<p>​				Binder的唯一标识, 一般用于当前Binder的全类名表示, 如com.lier.aidl.IBookManager</p>
<p>​		2: asInterface (android.os.IBinder obj)</p>
<p>​				用于将服务端的Binder对象转换为客户端所需的AIDL的接口类型对象,  客户端和服务端		在同一个进程的话, 就返回服务端的Stub对象本身, 否则返回系统封装后的Stud.proxy对象</p>
<p>​		3:  asBinder</p>
<p>​				返回当前Binder对象</p>
<p>​		4: asTransact</p>
<p>​				运行在服务端中的 Binder 线程池中，当客户端发起跨进程请求时，远程请求会通过系统		底层封装后交由此方法来处理。<strong>服务端通过 code 可以确定客户端所请求的目标方法是什么</strong>,		接着从data中取出目标方法所需的参数(如果目标方法有参数的话)，然后执行目标方法。当目		标方法执行完毕后，就向reply中写入返回值(如果目标方法有返回值的话)，onTransact方法		的执行过程就是这样的。需要注意的是，如果此方法返回false，那么客户端的请求会失败，		因此我们可以利用这个特性来做权限验证</p>
<p>​		5: Proxy#getBookList, Proxy#addBook</p>
<p>​				<strong>这个方法运行在客户端</strong>，当客户端远程调用此方法时，它的内部实现是这样的:</p>
<p>​		首先创建该方法所需要的输入型Parcel对象data、输出型Parcel对象reply和返回值对象 List;</p>
<p>​		然后把该方法的参数信息写入data中(如果有参数的话);接着调用transact方法来发起RPC(远		程过程调用)请求，同时当前线程挂起;然后服务端的onTransact方法会被调用，直到 RPC过		程返回后，当前线程继续执行，并从reply中取出RPC过程的返回结果;最后返回 reply 中的数		据。addBook没有返回值就不返回</p>
<p>![image-20240511105045794](D:\project\bolg\source_posts\Android IPC.assets\image-20240511105045794.png)</p>
<h6 id="3-2-2-Binder的死亡代理"><a href="#3-2-2-Binder的死亡代理" class="headerlink" title="3.2.2: Binder的死亡代理"></a>3.2.2: Binder的死亡代理</h6><p>​				当Binder运行在服务端的进程异常终止, 客户端就会远程调用失败, 为了解决这个问题, 		Binder提供了linkToDeath和unlinkToDeath两个方法, 通过linkToDeath方法可以给Binder设		置一个死亡代理, 当Binder死亡(异常终止), 客户端就可以收到通知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//服务端(IBookManager.aidl对应的java文件以生产)</span><br><br><span class="hljs-comment">//Binder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceBinder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IBookManager</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Book&gt; bookList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> IBinder mBinder;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title function_">getBookList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> bookList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(Book book)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        bookList.add(book);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkToDeath</span><span class="hljs-params">(IBinder mBinder)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-built_in">this</span>.mBinder = mBinder;<br>        mBinder.linkToDeath(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;<br>        Log.i(<span class="hljs-string">&quot;ServiceBinder&quot;</span>, <span class="hljs-string">&quot;Binder Death&quot;</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">//Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-type">ServiceBinder</span> <span class="hljs-variable">serviceBinder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceBinder</span>();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            serviceBinder.linkToDeath(serviceBinder);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> serviceBinder;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户端进程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MainActivity&quot;</span>;<br>    <span class="hljs-keyword">private</span> IBookManager mBookManager;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mIsBound; <span class="hljs-comment">//判断当前客户端是否绑定服务</span><br><br><br>    <span class="hljs-comment">//死亡代理</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IBinder.<span class="hljs-type">DeathRecipient</span> <span class="hljs-variable">mDeathRecipient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span>(mBookManager == <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            mBookManager.asBinder().unlinkToDeath(mDeathRecipient, <span class="hljs-number">0</span>);<br>            Log.i(TAG, <span class="hljs-string">&quot;Binder died&quot;</span>);<br>            mBookManager = <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-comment">//</span><br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">mConnection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> &#123;<br>            mBookManager = IBookManager.Stub.asInterface(service);<br>            mIsBound = <span class="hljs-literal">true</span>;<br><br>            <span class="hljs-comment">//连接服务时, 注册死亡代理</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                mBookManager.asBinder().linkToDeath(mDeathRecipient, <span class="hljs-number">0</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br><br>            <span class="hljs-comment">//连接成功后, 在这里可以电泳服务端的方法</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                mBookManager.addBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;安徒生童话&quot;</span>));<br>                mBookManager.addBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;格列佛游记&quot;</span>));<br>                mBookManager.addBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;原神启动&quot;</span>));<br>                List&lt;Book&gt; bookList = mBookManager.getBookList();<br>                <span class="hljs-keyword">for</span>(Book book : bookList)&#123;<br>                    Log.i(TAG, book.toString());<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName name)</span> &#123;<br>            <span class="hljs-comment">//连接断开</span><br>            mBookManager = <span class="hljs-literal">null</span>;<br>            mIsBound = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class);<br>        startService(intent);<br>        bindService(intent, mConnection, Context.BIND_ABOVE_CLIENT);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        <span class="hljs-keyword">if</span>(mIsBound)&#123;<br>            unbindService(mConnection);<br>            mIsBound = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h6 id="3-2-3-android中的IPC方式"><a href="#3-2-3-android中的IPC方式" class="headerlink" title="3.2.3: android中的IPC方式"></a>3.2.3: android中的IPC方式</h6><p>​			<strong>1: 使用Bundle</strong></p>
<p>​					由于Bundle实现了Parcelable接口, 所以其可以在不同进程间传输数据, 当在一个进程			中启动另一个进程的(Service, Receiver, Activity)时, 可以使用其传输数据(通过Intent附加			Bundle)</p>
<p>​			<strong>2: 文件共享</strong></p>
<p>​					 即多个进程通过读取同一个文件交换数据, 但会有并发问题,需要单独解决</p>
<p>​			<strong>3: Messenger</strong></p>
<p>​					 可通过Messenger在不同进程中传递Message对象, 是安卓提供得轻量级IPC方案, 底			层使用AIDL实现, 通过其构造函数可以看出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Messenger</span><span class="hljs-params">(IBinder target)</span>&#123;<br>	mTarget = IMessenger.Stub.asInterface(target);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​			且其一次只处理一个请求, 因此在服务端不用考虑线程同步问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//服务端进程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessengerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MessengerService&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MSG_FROM_CLIENT</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessengerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>            <span class="hljs-keyword">switch</span> (msg.what)&#123;<br>                <span class="hljs-keyword">case</span> MSG_FROM_CLIENT:<br>                    Log.i(TAG, <span class="hljs-string">&quot;resolve message&quot;</span>);<br>                    <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> (Bundle)msg.obj;<br>                    bundle.setClassLoader(getClass().getClassLoader());<br>                    <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> bundle.getParcelable(<span class="hljs-string">&quot;book&quot;</span>);<br>                    Log.i(TAG, book.toString());<br><br>                    <span class="hljs-comment">//封装返回给客户端进程得消息</span><br>                    <span class="hljs-type">Bundle</span> <span class="hljs-variable">serverBundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>                    serverBundle.putString(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;已经收到你的消息&quot;</span>);<br>                    serverBundle.putParcelable(<span class="hljs-string">&quot;book&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Spring技术卷&quot;</span>));<br><br>                    <span class="hljs-comment">//获取客户端设置得replyTo得Messenger</span><br>                    <span class="hljs-type">Messenger</span> <span class="hljs-variable">clientMessenger</span> <span class="hljs-operator">=</span> msg.replyTo;<br>                    <span class="hljs-type">Message</span> <span class="hljs-variable">obtain</span> <span class="hljs-operator">=</span> Message.obtain(<span class="hljs-literal">null</span>, SecondActivity.MSG_FROM_SERVER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                    obtain.obj = serverBundle;<br><br>                    <span class="hljs-comment">//发送消息会客户端</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        clientMessenger.send(obtain);<br>                    &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">super</span>.handleMessage(msg);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Messenger</span> <span class="hljs-variable">mMessenger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Messenger</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessengerHandler</span>());<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-keyword">return</span> mMessenger.getBinder();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//客户端进程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SecondActivity&quot;</span>;<br><br>    <span class="hljs-comment">//用于与服务端进程通信得Messenger对象</span><br>    <span class="hljs-keyword">private</span> Messenger mServiceMessenger;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">mServiceConnection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> &#123;<br>            mServiceMessenger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Messenger</span>(service);<br>            <span class="hljs-type">Message</span> <span class="hljs-variable">obtain</span> <span class="hljs-operator">=</span> Message.obtain(<span class="hljs-literal">null</span>, MessengerService.MSG_FROM_CLIENT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><span class="hljs-comment">//            obtain.obj = new Book(1, &quot;java编程思想&quot;);</span><br>            <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>            bundle.putParcelable(<span class="hljs-string">&quot;book&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;java编程思想&quot;</span>));<br>            obtain.obj = bundle;<br><br>            <span class="hljs-comment">//设置回复给哪个Messenger</span><br>            obtain.replyTo = mMessenger;<br>            <span class="hljs-keyword">try</span> &#123;<br>                mServiceMessenger.send(obtain);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName name)</span> &#123;<br><br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MessengerService.class);<br>        startService(intent);<br>        bindService(intent, mServiceConnection, Context.BIND_AUTO_CREATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        unbindService(mServiceConnection);<br>    &#125;<br><br>    <span class="hljs-comment">//以下适用于接收服务端返回得信息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MSG_FROM_SERVER</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessengerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>            <span class="hljs-keyword">switch</span> (msg.what)&#123;<br>                <span class="hljs-keyword">case</span> MSG_FROM_SERVER:<br>                    <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> (Bundle) msg.obj;<br>                    bundle.setClassLoader(getClass().getClassLoader());<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> bundle.getString(<span class="hljs-string">&quot;msg&quot;</span>);<br>                    Log.i(TAG, <span class="hljs-string">&quot;接收达服务端消息: &quot;</span> + info);<br>                    <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> bundle.getParcelable(<span class="hljs-string">&quot;book&quot;</span>);<br>                    Log.i(TAG, <span class="hljs-string">&quot;服务端book: &quot;</span> + book.toString());<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Messenger</span> <span class="hljs-variable">mMessenger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Messenger</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessengerHandler</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>![image-20240514143800049](D:\project\bolg\source_posts\Android IPC.assets\image-20240514143800049.png)</p>
<p>工作流程图: </p>
<p>![image-20240514143839622](D:\project\bolg\source_posts\Android IPC.assets\image-20240514143839622.png)</p>
<p>​		</p>
<h6 id="3-2-4-aidl的观察者模式"><a href="#3-2-4-aidl的观察者模式" class="headerlink" title="3.2.4: aidl的观察者模式"></a>3.2.4: aidl的观察者模式</h6><p>​			新增监听接口aidl文件, 在客户端重写该接口, 并注册到服务端进程中, 当服务端完成某项操	作后, 即可主动通知客户端进行数据刷新等做错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//aidl接口(INewBookArrivedListener.aidl)</span><br><span class="hljs-comment">// INewBookArrivedListener.aidl</span><br><span class="hljs-keyword">package</span> com.lier.aidl;<br><br><span class="hljs-keyword">import</span> com.lier.aidl.bean.Book;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">INewBookArrivedListener</span> &#123;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNewBookArrivedListener</span><span class="hljs-params">(in Book newBook)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户端进程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookNotifyManagerActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BookNotifyManagerActivity&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MSG_NEW_BOOK</span> <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;<br>    <span class="hljs-keyword">private</span> IBookManager mIBookManager;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>            <span class="hljs-keyword">switch</span> (msg.what)&#123;<br>                <span class="hljs-keyword">case</span> MSG_NEW_BOOK:<br>                    <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> (Book) msg.obj;<br>                    Log.i(TAG, <span class="hljs-string">&quot;new book arrived, bookName = &quot;</span> + book.bookName);<br>                    Toast.makeText(getApplicationContext(), <span class="hljs-string">&quot;new book arrived, booName = &quot;</span> + book.bookName,<br>                            Toast.LENGTH_LONG).show();<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">super</span>.handleMessage(msg);<br>            &#125;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">//监听器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">INewBookArrivedListener</span> <span class="hljs-variable">newBookArrivedListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">INewBookArrivedListener</span>.Stub() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNewBookArrivedListener</span><span class="hljs-params">(Book newBook)</span> &#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;in listener method&quot;</span>);<br>            mHandler.obtainMessage(MSG_NEW_BOOK, newBook).sendToTarget();<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">mServerConnection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> &#123;<br>            mIBookManager = IBookManager.Stub.asInterface(service);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                mIBookManager.addBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;斗破苍穹&quot;</span>));<br>                mIBookManager.addBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;武动乾坤&quot;</span>));<br>                mIBookManager.addBook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;大主宰&quot;</span>));<br><br>                List&lt;Book&gt; bookList = mIBookManager.getBookList();<br>                Log.i(TAG, <span class="hljs-string">&quot;print library&quot;</span>);<br>                <span class="hljs-keyword">for</span>(Book book : bookList)&#123;<br>                    Log.i(TAG, book.toString());<br>                &#125;<br><br>                <span class="hljs-comment">//注册监听</span><br>                mIBookManager.registerListener(newBookArrivedListener);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName name)</span> &#123;<br>            mIBookManager = <span class="hljs-literal">null</span>;<br>            Log.i(TAG, <span class="hljs-string">&quot;service died&quot;</span>);<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, MyService.class);<br>        bindService(intent, mServerConnection, Context.BIND_AUTO_CREATE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mIBookManager != <span class="hljs-literal">null</span> &amp;&amp; mIBookManager.asBinder().isBinderAlive()) &#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;unregister listener&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                mIBookManager.unregisterListener(newBookArrivedListener);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            unbindService(mServerConnection);<br>            <span class="hljs-built_in">super</span>.onDestroy();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//服务端进程</span><br><br><br><span class="hljs-comment">//Binder----&gt;ServiceBinder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceBinder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IBookManager</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ServiceBinder&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CopyOnWriteArrayList&lt;Book&gt; bookList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CopyOnWriteArrayList&lt;INewBookArrivedListener&gt; listenerList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> IBinder mBinder;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> CopyOnWriteArrayList&lt;Book&gt; <span class="hljs-title function_">getBookList</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> bookList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(Book book)</span>&#123;<br>        bookList.add(book);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerListener</span><span class="hljs-params">(INewBookArrivedListener listener)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">if</span>(listenerList.contains(listener))&#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;already exists&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        Log.i(TAG, <span class="hljs-string">&quot;register listener, listener: &quot;</span> + listener);<br>        listenerList.add(listener);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unregisterListener</span><span class="hljs-params">(INewBookArrivedListener listener)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">if</span>(!listenerList.contains(listener))&#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;listener not exists&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        Log.i(TAG, <span class="hljs-string">&quot;unregister listener&quot;</span>);<br>        listenerList.remove(listener);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkToDeath</span><span class="hljs-params">(IBinder mBinder)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-built_in">this</span>.mBinder = mBinder;<br>        mBinder.linkToDeath(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;<br>        Log.i(<span class="hljs-string">&quot;ServiceBinder&quot;</span>, <span class="hljs-string">&quot;Binder Death&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> CopyOnWriteArrayList&lt;INewBookArrivedListener&gt; <span class="hljs-title function_">getListenerList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> listenerList;<br>    &#125;<br><br>&#125;<br><br><br><br><span class="hljs-comment">//Service---&gt;MyService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MyService&quot;</span>;<br>    <span class="hljs-keyword">private</span> ServiceBinder serviceBinder;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">mIsServiceDestroyed</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);<span class="hljs-comment">//判断当前service是否销毁</span><br>    <span class="hljs-keyword">private</span> CopyOnWriteArrayList&lt;Book&gt; mBookList;<br>    <span class="hljs-keyword">private</span> CopyOnWriteArrayList&lt;INewBookArrivedListener&gt; mListenerList;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-keyword">if</span>(serviceBinder == <span class="hljs-literal">null</span>)&#123;<br>            serviceBinder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceBinder</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            serviceBinder.linkToDeath(serviceBinder);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> serviceBinder;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate();<br>        serviceBinder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceBinder</span>();<br>        mBookList = serviceBinder.getBookList();<br>        mListenerList = serviceBinder.getListenerList();<br><br><br>        <span class="hljs-comment">//新建线程, 10s创建一本新书</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (!mIsServiceDestroyed.get())&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">bookId</span> <span class="hljs-operator">=</span> mBookList.size() + <span class="hljs-number">1</span>;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">bookName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new book name-&quot;</span> + bookId;<br>                <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(bookId, bookName);<br><br>                <span class="hljs-comment">//通知新书已到</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    onNewBookArrived(book);<br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        mIsServiceDestroyed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//新书到了, 通知所有注册的listener</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNewBookArrived</span><span class="hljs-params">(Book book)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-comment">//新书抵达, 添加到集合</span><br>        mBookList.add(book);<br>        Log.i(TAG, <span class="hljs-string">&quot;new book arrived, book = &quot;</span> + book);<br>        <span class="hljs-keyword">for</span>(INewBookArrivedListener newBookArrivedListener : mListenerList)&#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;notify register listener, listener: &quot;</span> + newBookArrivedListener);<br>            newBookArrivedListener.onNewBookArrivedListener(book);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>   <strong>tips:</strong> 由于上述代码中的INewBookArrivedListener从客户端传递到服务端后, Binder会将它转换为一个新的对象, 会导致后续取消注册时, 无法取消,(不同的对象地址不一样,, 无法从集合中移除)</p>
<p>![image-20240515100605346](D:\project\bolg\source_posts\Android IPC.assets\image-20240515100605346.png)</p>
<p>​	<strong>解决:</strong> 使用RemoteCallbackList,  RemoteCallbackList是系统提供用于跨进程删除listener的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteCallbackList</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IInterface</span>&gt;&#123;<br>    ...<br>    ArrayMap&lt;IBinder, CallBack&gt; mCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;&gt;();<br>    ...<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 其内部有一个ArrayMap用于保存所有AIDL的回调</span><br><span class="hljs-comment">* 客户端注册listener时, 会把其信息存到mCallbacks中</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-comment">//修改后</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MyService&quot;</span>;<br>    <span class="hljs-keyword">private</span> ServiceBinder serviceBinder;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">mIsServiceDestroyed</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);<span class="hljs-comment">//判断当前service是否销毁</span><br>    <span class="hljs-keyword">private</span> CopyOnWriteArrayList&lt;Book&gt; mBookList;<br>    <span class="hljs-keyword">private</span> RemoteCallbackList&lt;INewBookArrivedListener&gt; mListenerList;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        <span class="hljs-keyword">if</span>(serviceBinder == <span class="hljs-literal">null</span>)&#123;<br>            serviceBinder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceBinder</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            serviceBinder.linkToDeath(serviceBinder);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> serviceBinder;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate();<br>        serviceBinder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceBinder</span>();<br>        mBookList = serviceBinder.getBookList();<br>        mListenerList = serviceBinder.getListenerList();<br><br><br>        <span class="hljs-comment">//新建线程, 10s创建一本新书</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (!mIsServiceDestroyed.get())&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">bookId</span> <span class="hljs-operator">=</span> mBookList.size() + <span class="hljs-number">1</span>;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">bookName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new book name-&quot;</span> + bookId;<br>                <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(bookId, bookName);<br><br>                <span class="hljs-comment">//通知新书已到</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    onNewBookArrived(book);<br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        mIsServiceDestroyed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//新书到了, 通知所有注册的listener</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNewBookArrived</span><span class="hljs-params">(Book book)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-comment">//新书抵达, 添加到集合</span><br>        mBookList.add(book);<br>        Log.i(TAG, <span class="hljs-string">&quot;new book arrived, book = &quot;</span> + book);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> mListenerList.beginBroadcast();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++)&#123;<br>            <span class="hljs-type">INewBookArrivedListener</span> <span class="hljs-variable">broadcastItem</span> <span class="hljs-operator">=</span> mListenerList.getBroadcastItem(i);<br>            broadcastItem.onNewBookArrivedListener(book);<br>        &#125;<br><br>        <span class="hljs-comment">//通知所有listener</span><br>        mListenerList.finishBroadcast();<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceBinder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IBookManager</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ServiceBinder&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CopyOnWriteArrayList&lt;Book&gt; bookList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">//使用RemoteCallbackList</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RemoteCallbackList&lt;INewBookArrivedListener&gt; listenerList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteCallbackList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> IBinder mBinder;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> CopyOnWriteArrayList&lt;Book&gt; <span class="hljs-title function_">getBookList</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> bookList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(Book book)</span>&#123;<br>        bookList.add(book);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerListener</span><span class="hljs-params">(INewBookArrivedListener listener)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><br>        Log.i(TAG, <span class="hljs-string">&quot;register listener, listener: &quot;</span> + listener);<br>        listenerList.register(listener);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unregisterListener</span><span class="hljs-params">(INewBookArrivedListener listener)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;unregister listener&quot;</span>);<br>        listenerList.unregister(listener);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkToDeath</span><span class="hljs-params">(IBinder mBinder)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-built_in">this</span>.mBinder = mBinder;<br>        mBinder.linkToDeath(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;<br>        Log.i(<span class="hljs-string">&quot;ServiceBinder&quot;</span>, <span class="hljs-string">&quot;Binder Death&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> RemoteCallbackList&lt;INewBookArrivedListener&gt; <span class="hljs-title function_">getListenerList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> listenerList;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>​	<strong>原理:</strong> 使用listener.asBinder()的值作为ArrayMap的key值, 就算多次跨进程传输后, 同一个对象会在服务端和客户端生成不同的对象, 但是其底层的Binder都是同一个</p>
<p>​	<strong>且客户端终止后, RemoteCallbackList会自动移除其注册的listener</strong></p>
<p>​	<strong>tips:</strong> </p>
<p>​		(1): 客户端调用远程服务的方法，被调用的方法运行在服务端的 Binder 线程池中，同时客户	端线程会被挂起，这个时候如果服务端方法执行比较耗时，就会导致客户端线程长时间地阻塞	在这里，而如果这个客户端线程是UI线程的话，就会导致客户端ANR</p>
<p>​			<strong>由于客户端的onServiceConnected和onServiceDisconnected方法都运行在U线程中，	所以也不可以在它们里面直接调用服务端的耗时方法</strong>，反之也一样, 不可以在服务端UI线程调用	客户端耗时的方法</p>
<p>​		(2): 由于服务端的方法本身就运行在服务端的<strong>Binder线程池</strong>中，所以<strong>服务端方法本身就可以	执行大量耗时操作</strong>，这个时候切记不要在服务端方法中开线程去进行异步任务，</p>
<h6 id="3-2-5-ContentProvider跨进程通信"><a href="#3-2-5-ContentProvider跨进程通信" class="headerlink" title="3.2.5: ContentProvider跨进程通信"></a>3.2.5: ContentProvider跨进程通信</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//数据库Util</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DBOpenHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SQLiteOpenHelper</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DB_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;provider_db&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">BOOK_TABLE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;book&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_TABLE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CREATE_BOOK_TABLE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;create table &quot;</span> + BOOK_TABLE_NAME + <span class="hljs-string">&quot;(\n&quot;</span> +<br>            <span class="hljs-string">&quot;\tbook_id int primary key,\n&quot;</span> +<br>            <span class="hljs-string">&quot;\tbook_name varchar(50)\n&quot;</span> +<br>            <span class="hljs-string">&quot;)&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CREATE_USER_TABLE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;create table &quot;</span> + USER_TABLE_NAME + <span class="hljs-string">&quot;(\n&quot;</span> +<br>            <span class="hljs-string">&quot;\tid int primary key,\n&quot;</span> +<br>            <span class="hljs-string">&quot;\t`name` varchar(20),\n&quot;</span> +<br>            <span class="hljs-string">&quot;\tsex int\n&quot;</span> +<br>            <span class="hljs-string">&quot;)&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DBOpenHelper</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Context context,</span><br><span class="hljs-params">                        <span class="hljs-meta">@Nullable</span> String name,</span><br><span class="hljs-params">                        <span class="hljs-meta">@Nullable</span> SQLiteDatabase.CursorFactory factory, <span class="hljs-type">int</span> version)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context, name, factory, version);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(SQLiteDatabase db)</span> &#123;<br>        db.execSQL(CREATE_BOOK_TABLE);<br>        db.execSQL(CREATE_USER_TABLE);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUpgrade</span><span class="hljs-params">(SQLiteDatabase db, <span class="hljs-type">int</span> oldVersion, <span class="hljs-type">int</span> newVersion)</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//服务端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentProvider</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BookProvider&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AUTHORITY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.lier.aidl.provider.BookProvider&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Uri</span> <span class="hljs-variable">BOOK_CONTENT_URI</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://&quot;</span> + AUTHORITY + <span class="hljs-string">&quot;/book&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Uri</span> <span class="hljs-variable">USER_CONTENT_URI</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">&quot;content://&quot;</span> + AUTHORITY + <span class="hljs-string">&quot;/user&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BOOK_CONTENT_URI_CODE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">USER_CONTENT_URI_CODE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">UriMatcher</span> <span class="hljs-variable">mUriMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UriMatcher</span>(UriMatcher.NO_MATCH);<br><br>    <span class="hljs-keyword">static</span>&#123;<br>        mUriMatcher.addURI(AUTHORITY, <span class="hljs-string">&quot;book&quot;</span>, BOOK_CONTENT_URI_CODE);<br>        mUriMatcher.addURI(AUTHORITY, <span class="hljs-string">&quot;user&quot;</span>, USER_CONTENT_URI_CODE);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> SQLiteDatabase sqLiteDatabase;<br><br><br>    <span class="hljs-comment">//根据uri匹配表名</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getTableName</span><span class="hljs-params">(Uri uri)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">switch</span> (mUriMatcher.match(uri))&#123;<br>            <span class="hljs-keyword">case</span> BOOK_CONTENT_URI_CODE:<br>                tableName = DBOpenHelper.BOOK_TABLE_NAME;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> USER_CONTENT_URI_CODE:<br>                tableName = DBOpenHelper.USER_TABLE_NAME;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> tableName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;in onCreate, thread name = &quot;</span> + Thread.currentThread().getName());<br>        <span class="hljs-type">DBOpenHelper</span> <span class="hljs-variable">dbOpenHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DBOpenHelper</span>(getContext(), DBOpenHelper.DB_NAME, <span class="hljs-literal">null</span>, <span class="hljs-number">1</span>);<br>        sqLiteDatabase = dbOpenHelper.getWritableDatabase();<br>        initData();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initData</span><span class="hljs-params">()</span>&#123;<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;insert into book values(1, &#x27;斗破苍穹&#x27;)&quot;</span>);<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;insert into book values(2, &#x27;元神启动&#x27;)&quot;</span>);<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;insert into book values(3, &#x27;大主宰&#x27;)&quot;</span>);<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;insert into book values(4, &#x27;武动乾坤&#x27;)&quot;</span>);<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;insert into user values(1, &#x27;离👂&#x27;, 1)&quot;</span>);<br>        sqLiteDatabase.execSQL(<span class="hljs-string">&quot;insert into user values(2, &#x27;lier&#x27;, 1)&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Cursor <span class="hljs-title function_">query</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String[] projection, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs, <span class="hljs-meta">@Nullable</span> String sortOrder)</span> &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;in query, thread name = &quot;</span> + Thread.currentThread().getName());<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> getTableName(uri);<br>        <span class="hljs-keyword">if</span>(tableName == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;target table is not exists, uri = &quot;</span> + uri);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sqLiteDatabase.query(tableName, projection, selection, selectionArgs,<br>                <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, sortOrder, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri)</span> &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;in getType, thread name = &quot;</span> + Thread.currentThread().getName());<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Uri <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> ContentValues values)</span> &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;in insert, thread name = &quot;</span> + Thread.currentThread().getName());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> getTableName(uri);<br>        <span class="hljs-keyword">if</span>(tableName == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;target table is not exists, uri = &quot;</span> + uri);<br>        &#125;<br>        sqLiteDatabase.insert(tableName,<span class="hljs-literal">null</span>, values);<br>        <span class="hljs-keyword">return</span> uri;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs)</span> &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;in delete, thread name = &quot;</span> + Thread.currentThread().getName());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> getTableName(uri);<br>        <span class="hljs-keyword">if</span>(tableName == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;target table is not exists, uri = &quot;</span> + uri);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sqLiteDatabase.delete(tableName,selection, selectionArgs);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Uri uri, <span class="hljs-meta">@Nullable</span> ContentValues values, <span class="hljs-meta">@Nullable</span> String selection, <span class="hljs-meta">@Nullable</span> String[] selectionArgs)</span> &#123;<br>        Log.i(TAG, <span class="hljs-string">&quot;in update, thread name = &quot;</span> + Thread.currentThread().getName());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> getTableName(uri);<br>        <span class="hljs-keyword">if</span>(tableName == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;target table is not exists, uri = &quot;</span> + uri);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sqLiteDatabase.update(tableName,values, selection, selectionArgs);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ProviderActivity&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONTENT_URI</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;content://com.lier.aidl.provider.BookProvider&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <br>        <span class="hljs-comment">//book</span><br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(CONTENT_URI + <span class="hljs-string">&quot;/book&quot;</span>);<br>        <span class="hljs-type">ContentValues</span> <span class="hljs-variable">contentValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>        contentValues.put(<span class="hljs-string">&quot;book_id&quot;</span>, <span class="hljs-number">5</span>);<br>        contentValues.put(<span class="hljs-string">&quot;book_name&quot;</span>, <span class="hljs-string">&quot;安卓开发艺术探索&quot;</span>);<br>        getContentResolver().insert(uri, contentValues);<br><br>        <span class="hljs-type">Cursor</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> getContentResolver().query(uri, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;book_id&quot;</span>, <span class="hljs-string">&quot;book_name&quot;</span>&#125;,<br>                <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">while</span> (query.moveToNext())&#123;<br>            <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br>            book.bookId = query.getInt(<span class="hljs-number">0</span>);<br>            book.bookName = query.getString(<span class="hljs-number">1</span>);<br>            Log.i(TAG, book.toString());<br>        &#125;<br><br>        query.close();<br>        <br>        <span class="hljs-comment">//user</span><br>        <span class="hljs-type">Uri</span> <span class="hljs-variable">userUri</span> <span class="hljs-operator">=</span> Uri.parse(CONTENT_URI + <span class="hljs-string">&quot;/user&quot;</span>);<br>        <span class="hljs-type">ContentValues</span> <span class="hljs-variable">userValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();<br>        userValues.put(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">3</span>);<br>        userValues.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;薇薇简&quot;</span>);<br>        userValues.put(<span class="hljs-string">&quot;sex&quot;</span>, <span class="hljs-number">0</span>);<br>        getContentResolver().insert(userUri, userValues);<br><br>        <span class="hljs-type">Cursor</span> <span class="hljs-variable">userCursor</span> <span class="hljs-operator">=</span> getContentResolver().query(userUri, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;sex&quot;</span>&#125;,<br>                <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <br>        <span class="hljs-keyword">while</span> (userCursor.moveToNext())&#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            user.setId(userCursor.getInt(<span class="hljs-number">0</span>));<br>            user.setName(userCursor.getString(<span class="hljs-number">1</span>));<br>            user.setSex(userCursor.getInt(<span class="hljs-number">2</span>));<br><br>            Log.i(TAG, user.toString());<br>        &#125;<br><br>        userCursor.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​	</p>
<h6 id="3-2-6-Socket跨进程通信"><a href="#3-2-6-Socket跨进程通信" class="headerlink" title="3.2.6: Socket跨进程通信"></a>3.2.6: Socket跨进程通信</h6><p>​		使用Socket网络套接字可在系统中跨进程通信</p>
<h5 id="3-3-Binder连接池"><a href="#3-3-Binder连接池" class="headerlink" title="3.3: Binder连接池"></a>3.3: Binder连接池</h5><p>​		<strong>问题:</strong> 由于多个业务模块需要使用AIDL在进程间通信, 但是每个AIDL需要绑定一个Service, 会导致出现多个Service消耗系统资源</p>
<p>​		<strong>解决:</strong> 将所有的AIDL交有一个Service管理, 每个业务模块只需要创建自己的AIDL接口并实现, 然后向服务端提供唯一标识和Binder即可, 对于服务端, 只需要提供一个queryBinder接口, 用于根据业务模块的标识返回相应的Binder即可</p>
<p>​		<strong>结论:</strong> Binder连接池就是将每个业务模块的Binder请求统一转发到远程Service中执行, 从而避免重复创建Service的过程</p>
<p>![image-20240516160137539](D:\project\bolg\source_posts\Android IPC.assets\image-20240516160137539.png)</p>
<p>​		<strong>Demo实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//aidl</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ICompute</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISecurityCenter</span> &#123;<br><br>    String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String content)</span>;<br>    String <span class="hljs-title function_">decrypt</span><span class="hljs-params">(String password)</span>;<br>&#125;<br><br><span class="hljs-comment">//实现</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComputeImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ICompute</span>.Stub&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> a + b;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityCenterImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ISecurityCenter</span>.Stub &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> <span class="hljs-variable">SECRET_CODE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;^&#x27;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String content)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-type">char</span>[] charArray = content.toCharArray();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; charArray.length; i++) &#123;<br>            charArray[i] ^= SECRET_CODE;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(charArray);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">decrypt</span><span class="hljs-params">(String password)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> encrypt(password);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//binder pool query binder aidl</span><br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IBinderPool</span> &#123;<br><br>    IBinder <span class="hljs-title function_">queryBinder</span><span class="hljs-params">(<span class="hljs-type">int</span> binderCode)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Binder pool实现</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BinderPool</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BinderPool&quot;</span>;<br>    <span class="hljs-keyword">private</span> Context mContext;<br><br>    <span class="hljs-comment">//JUC减少计数--&gt;辅助类</span><br>    <span class="hljs-keyword">private</span> CountDownLatch mCountDownLatch;<br>   <br>    <span class="hljs-keyword">private</span> IBinderPool mIBinderPool;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> BinderPool sBinderPoolInstance;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BinderPool</span><span class="hljs-params">(Context context)</span>&#123;<br>        <span class="hljs-built_in">this</span>.mContext = context.getApplicationContext();<br>        <span class="hljs-comment">//连接服务</span><br>        connectBinderPoolService();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BinderPool <span class="hljs-title function_">getInstance</span><span class="hljs-params">(Context context)</span>&#123;<br>        <span class="hljs-keyword">if</span>(sBinderPoolInstance == <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">synchronized</span> (BinderPool.class)&#123;<br>                <span class="hljs-keyword">if</span>(sBinderPoolInstance == <span class="hljs-literal">null</span>)&#123;<br>                    sBinderPoolInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BinderPool</span>(context);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sBinderPoolInstance;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">queryBinder</span><span class="hljs-params">(<span class="hljs-type">int</span> binderCode)</span>&#123;<br>        <span class="hljs-type">IBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span>(mIBinderPool != <span class="hljs-literal">null</span>) &#123;<br>                binder = mIBinderPool.queryBinder(binderCode);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> binder;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">mBinderPoolConnection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> &#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;connect success&quot;</span>);<br>            mIBinderPool = IBinderPool.Stub.asInterface(service);<br>            <span class="hljs-keyword">try</span> &#123;<br>                mIBinderPool.asBinder().linkToDeath(mDeathRecipient, <span class="hljs-number">0</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            mCountDownLatch.countDown();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName name)</span> &#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;connect fail&quot;</span>);<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectBinderPoolService</span><span class="hljs-params">()</span>&#123;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            初始化减少计数, 等待mBinderPoolConnection bind service成功</span><br><span class="hljs-comment">            即为mCountDownLatch.countDown();mCountDownLatch == 0时</span><br><span class="hljs-comment">            用于确保绑定Service成功,</span><br><span class="hljs-comment">         */</span><br>        mCountDownLatch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(mContext, BinderPoolService.class);<br>        mContext.bindService(intent, mBinderPoolConnection, Context.BIND_AUTO_CREATE);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            mCountDownLatch.await();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//死亡代理</span><br>    <span class="hljs-keyword">private</span> IBinder.<span class="hljs-type">DeathRecipient</span> <span class="hljs-variable">mDeathRecipient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;binder died&quot;</span>);<br>            mIBinderPool.asBinder().unlinkToDeath(mDeathRecipient, <span class="hljs-number">0</span>);<br>            mIBinderPool = <span class="hljs-literal">null</span>;<br>            <span class="hljs-comment">//Service断开重连</span><br>            connectBinderPoolService();<br>        &#125;<br>    &#125;;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	* query binder aild 的实现, 当有新的aidl无需创建service, 约定一个binderCode</span><br><span class="hljs-comment">    * 在这里放回aidl的实现类即可</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BinderPoolImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IBinderPool</span>.Stub&#123;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">BinderPoolImpl</span><span class="hljs-params">()</span>&#123;<br>            <span class="hljs-built_in">super</span>();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">queryBinder</span><span class="hljs-params">(<span class="hljs-type">int</span> binderCode)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>            <span class="hljs-type">IBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">switch</span> (binderCode)&#123;<br>                <span class="hljs-keyword">case</span> Constant.BINDER_SECURITY_CENTER:<br>                    binder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityCenterImpl</span>();<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> Constant.BINDER_COMPUTE:<br>                    binder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComputeImpl</span>();<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> binder;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//客户端调用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MainActivity&quot;</span>;<br>    <span class="hljs-keyword">private</span> ISecurityCenter securityCenter;<br>    <span class="hljs-keyword">private</span> ICompute compute;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>::doWork).start();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span>&#123;<br><br><br>        <span class="hljs-type">BinderPool</span> <span class="hljs-variable">binderPool</span> <span class="hljs-operator">=</span> BinderPool.getInstance(MainActivity.<span class="hljs-built_in">this</span>);<br><br>        <span class="hljs-comment">//ISecurityCenter</span><br>        <span class="hljs-type">IBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> binderPool.queryBinder(Constant.BINDER_SECURITY_CENTER);<br><br>        <span class="hljs-comment">//asInterface: 将Bider对象转为具体的接口对象</span><br>        securityCenter = SecurityCenterImpl.asInterface(binder);<br>        Log.i(TAG, <span class="hljs-string">&quot;get ISecurityCenter&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello world&quot;</span>;<br>        Log.d(TAG, <span class="hljs-string">&quot;msg content: &quot;</span> + msg);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> securityCenter.encrypt(msg);<br>            Log.d(TAG, <span class="hljs-string">&quot;msg after encrypt content: &quot;</span> + password);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">decrypt</span> <span class="hljs-operator">=</span> securityCenter.decrypt(password);<br>            Log.d(TAG, <span class="hljs-string">&quot;msg after decrypt content: &quot;</span> + decrypt);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>        <span class="hljs-comment">//ICompute</span><br>        <span class="hljs-type">IBinder</span> <span class="hljs-variable">computeBinder</span> <span class="hljs-operator">=</span> binderPool.queryBinder(Constant.BINDER_COMPUTE);<br>        compute = ComputeImpl.asInterface(computeBinder);<br><br>        Log.i(TAG, <span class="hljs-string">&quot;get ICompute&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> compute.add(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);<br>            Log.i(TAG, <span class="hljs-string">&quot;compute add result = &quot;</span> + res);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>结果:</strong> </p>
<p>![image-20240520144652244](D:\project\bolg\source_posts\Android IPC.assets\image-20240520144652244.png)</p>
<h4 id="4-结论"><a href="#4-结论" class="headerlink" title="4: 结论"></a>4: 结论</h4><table>
<thead>
<tr>
<th>名称</th>
<th>优点</th>
<th>缺点</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td>Bundle</td>
<td>easy</td>
<td>只能传输Bundle支持的数据类型</td>
<td>四大组件的进程间通信</td>
</tr>
<tr>
<td>文件共享</td>
<td>easy</td>
<td>不适合高并发场景, 无法在进程间即时通信</td>
<td>无并发要求, 交换简单数据且对实时性要求不高场景</td>
</tr>
<tr>
<td>AIDL</td>
<td>支持一对多<strong>并发</strong>通讯, 实时通讯,RPC</td>
<td>线程同步处理较为复杂</td>
<td>一对多通信, 且有RPC要求</td>
</tr>
<tr>
<td>Messenger</td>
<td>一对多<strong>串行</strong>通信, 实时通信</td>
<td>串行处理数据, 高并发场景不好处理, 数据通过Message进行传输, 也只能传输Bundle支持的数据类型, 不支持RPC</td>
<td>低并发的一对多即时通信, 无需返回结果的RPC需求</td>
</tr>
<tr>
<td>ConnectProvider</td>
<td>支持一对多并发数据共享</td>
<td>主要提供数据源的CRUD操作</td>
<td>一对多进程间数据共享</td>
</tr>
<tr>
<td>Socket</td>
<td>通过网络传输字节流, 支持一对多并发实时通信</td>
<td>实现细节繁琐</td>
<td>网络数据交换</td>
</tr>
</tbody></table>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/05/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Android%20View/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/08/%E6%B7%BB%E5%8A%A0%E9%81%A5%E6%8E%A7%E6%8C%89%E9%94%AE/">
                        <span class="hidden-mobile">添加遥控按键</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-love"></i>lier 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
